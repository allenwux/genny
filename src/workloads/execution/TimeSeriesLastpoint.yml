SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This test exercises the behavior of lastpoint-type queries on time-series collections. The
  currently supported lastpoint aggregate pipelines that are tested here include:
    1. a $sort on a meta field (ascending, descending) and time (descending) and $group with _id on the meta
       field and only $first accumulators.
    2. a $sort on a meta field (ascending, descending) and time (ascending) and $group with _id on the meta
       field and only $last accumulators.
    3. any of the above pipelines with a preceding match predicate on a meta field.

Actors:
- Name: CreateTimeSeriesCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: &db test
    Operation:
      OperationMetricsName: CreateTimeSeriesCollection
      OperationName: RunCommand
      OperationCommand:
        {create: &coll Collection0, timeseries: {timeField: "timestamp", metaField: "metadata"}}
  - &Nop {Nop: true}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: *db
    Collection: *coll
    Threads: 1
    CollectionCount: 1
    DocumentCount: 1000000
    BatchSize: 100
    Document:
      timestamp: {^RandomDate: {min: "2022-01-01", max: "2022-03-01"}}
      metadata: {
        sensorId: {^RandomInt: {min: 0, max: 100}},
        type: "temperature"
      }
      temp: {^RandomDouble: {min: -30, max: 120}}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

# Lastpoint query with ascending index on meta subfield and descending index on time.
- Name: RunLastpointQueryWithMetaSubfieldAscendingTimeDescending
  Type: RunCommand
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - LoadConfig:
      Path: &phasePath ../../phases/execution/TimeSeriesLastpoint.yml
      Key: CreateIndex
      Parameters:
        Collection: *coll
        IndexName: &metaAscTimeDesc "MetaSubfieldAscendingTimeDescending"
        IndexPattern: {"metadata.sensorId": 1, timestamp: -1}
  - LoadConfig:
      Path: *phasePath
      Key: Quiesce
  - LoadConfig:
      Path: *phasePath
      Key: RunLastPointQuery
      Parameters:
        Collection: *coll
        SortPattern: {"metadata.sensorId": 1, timestamp: -1}
        GroupPattern: {_id: "$metadata.sensorId", timestamp: {$first: "$timestamp"}, temp: {$first: "$temp"}}
  - LoadConfig:
      Path: *phasePath
      Key: DropIndex
      Parameters:
        Collection: *coll
        IndexName: *metaAscTimeDesc
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

# Lastpoint query with descending index on meta subfield and descending index on time.
- Name: RunLastpointQueryWithMetaSubfieldDescendingTimeDescending
  Type: RunCommand
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *phasePath
      Key: CreateIndex
      Parameters:
        Collection: *coll
        IndexName: &metaDescTimeDesc "MetaSubfieldDescendingTimeDescending"
        IndexPattern: {"metadata.sensorId": -1, timestamp: -1}
  - LoadConfig:
      Path: *phasePath
      Key: Quiesce
  - LoadConfig:
      Path: *phasePath
      Key: RunLastPointQuery
      Parameters:
        Collection: *coll
        SortPattern: {"metadata.sensorId": -1, timestamp: -1}
        GroupPattern: {_id: "$metadata.sensorId", timestamp: {$first: "$timestamp"}, temp: {$first: "$temp"}}
  - LoadConfig:
      Path: *phasePath
      Key: DropIndex
      Parameters:
        Collection: *coll
        IndexName: *metaDescTimeDesc
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

# Lastpoint query with descending index on meta subfield and ascending index on time.
- Name: RunLastpointQueryWithMetaSubfieldDescendingTimeAscending
  Type: RunCommand
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *phasePath
      Key: CreateIndex
      Parameters:
        Collection: *coll
        IndexName: &metaDescTimeAsc "MetaSubfieldDescendingTimeAscending"
        IndexPattern: {"metadata.sensorId": -1, timestamp: 1}
  - LoadConfig:
      Path: *phasePath
      Key: Quiesce
  - LoadConfig:
      Path: *phasePath
      Key: RunLastPointQuery
      Parameters:
        Collection: *coll
        SortPattern: {"metadata.sensorId": -1, timestamp: 1}
        GroupPattern: {_id: "$metadata.sensorId", timestamp: {$last: "$timestamp"}, temp: {$last: "$temp"}}
  - LoadConfig:
      Path: *phasePath
      Key: DropIndex
      Parameters:
        Collection: *coll
        IndexName: *metaDescTimeAsc
  - *Nop
  - *Nop
  - *Nop
  - *Nop

# Lastpoint query with ascending index on meta subfield and ascending index on time.
- Name: RunLastpointQueryWithMetaSubfieldAscendingTimeDescending
  Type: RunCommand
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *phasePath
      Key: CreateIndex
      Parameters:
        Collection: *coll
        IndexName: &metaAscTimeAsc "MetaSubfieldAscendingTimeDescending"
        IndexPattern: {"metadata.sensorId": 1, timestamp: 1}
  - LoadConfig:
      Path: *phasePath
      Key: Quiesce
  - LoadConfig:
      Path: *phasePath
      Key: RunLastPointQuery
      Parameters:
        Collection: *coll
        SortPattern: {"metadata.sensorId": 1, timestamp: 1}
        GroupPattern: {_id: "$metadata.sensorId", timestamp: {$last: "$timestamp"}, temp: {$last: "$temp"}}
  - LoadConfig:
      Path: *phasePath
      Key: DropIndex
      Parameters:
        Collection: *coll
        IndexName: *metaAscTimeAsc

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-all-feature-flags
      - replica
      - replica-all-feature-flags
      - shard-lite
      - shard-lite-all-feature-flags
