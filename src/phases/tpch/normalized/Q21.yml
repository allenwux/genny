SchemaVersion: 2018-07-01
Owner: "@mongodb/product-query"
Description: |
  Run TPC-H query 21 against the normalized schema.

batchSize: &batchSize 101 # The default batch size.
query21Nation: &query21Nation "SAUDI ARABIA"

TPCHNormalizedQuery21:
  Repeat: 1
  Database: tpch
  Operations:
  - OperationMetricsName: Query21
    OperationName: RunCommand
    OperationCommand:
      explain:
        aggregate: supplier
        pipeline:
          [
            {$lookup: {from: "nation", localField: "s_nationkey", foreignField: "n_nationkey", as: "nation"}},
            {$unwind: "$nation"},
            {$match: {"nation.n_name": {^Parameter: {Name: "Query1Delta", Default: *query21Nation}}}},
            {$lookup: {from: "lineitem", localField: "s_suppkey", foreignField: "l_suppkey", as: "l1", pipeline: [{$match: {$expr: {$gt: ["$l_receiptdate", "$l_commitdate"]}}}]}},
            {$unwind: "$l1"},
            {$lookup: {from: "orders", localField: "l1.l_orderkey", foreignField: "o_orderkey", as: "orders", pipeline: [{$match: {o_orderstatus: "F"}}]}},
            {$unwind: "$orders"},
            {$lookup: {from: "lineitem", let: {l1: "$l1"}, localField: "l1.l_orderkey", foreignField: "l_orderkey", as: "lineitem", pipeline: [
              {$match: {$expr: {$ne: ["$$l1.l_suppkey", "$l_suppkey"]}}},
              {$group: {_id: {}, l2_count: {$count: {}}, l3_count: {$sum: {$cond: {if: {$gt: ["$l_receiptdate", "$l_commitdate"]}, then: 1, else: 0}}}}}]}},
            {$unwind: "$lineitem"},
            {$match: {$and: [
              {$expr: {$gt: ["$lineitem.l2_count", 0]}},
              {$expr: {$eq: ["$lineitem.l3_count", 0]}}]}},
            {$group: {_id: "$s_name", numwait: {$count: {}}}},
            {$project: {_id: 0, s_name: "$_id", numwait: 1}},
            {$sort: {numwait: -1, s_name: 1}},
            {$limit: 100}
          ]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
      verbosity:
        executionStats
