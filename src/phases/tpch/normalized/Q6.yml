SchemaVersion: 2018-07-01
Owner: "@mongodb/product-query"
Description: |
  Run TPC-H query 6 against the normalized schema. Using an 'executionStats' explain causes each command to run its execution plan until no
  documents remain, which ensures that the query executes in its entirety.

batchSize: &batchSize 101  # The default batch size.

query6Date: &query6Date "1994-01-01"
query6Discount: &query6Discount 0.06
query6Quantity: &query6Quantity 24

TPCHNormalizedQuery6:
  Repeat: 1
  Database: tpch
  Operations:
  - OperationMetricsName: Query6
    OperationName: RunCommand
    OperationCommand:
      explain:
        aggregate: lineitem
        pipeline:
          [
            {$match: {$and: [
              {$expr: {$gte: ["$l_shipdate", {$dateFromString: {dateString: {^Parameter: {Name: "Query6Date", Default: *query6Date}}}}]}},
              {$expr: {$lt: ["$l_shipdate", {$dateAdd: {startDate: {$dateFromString: {dateString: {^Parameter: {Name: "Query6Date", Default: *query6Date}}}}, unit: "year", amount: 1}}]}},
              {$expr: {$gte: ["$l_discount", {$subtract: [{^Parameter: {Name: "Query6Discount", Default: *query6Discount}}, 0.01]}]}},
              {$expr: {$lte: ["$l_discount", {$add: [{^Parameter: {Name: "Query6Discount", Default: *query6Discount}}, 0.011]}]}},
              {$expr: {$lt: ["$l_quantity", {^Parameter: {Name: "Query6Quantity", Default: *query6Quantity}}]}}]}},
            {$group: {_id: 0, revenue: {$sum: {$multiply: ["$l_extendedprice", "$l_discount"]}}}},
            {$project: {_id: 0, revenue: 1}},
          ]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
      verbosity:
        executionStats
